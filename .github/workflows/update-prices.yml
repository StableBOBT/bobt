# BOBT Oracle Price Updater
#
# Automatically updates BOB/USDT prices from CriptoYa P2P data
# Runs every 5 minutes via GitHub Actions
#
# Required secrets:
#   STELLAR_SECRET_KEY  - Operator's secret key (testnet)
#   ORACLE_CONTRACT_ID  - Oracle contract address

name: Update Oracle Prices

on:
  schedule:
    # Every 5 minutes for fresh P2P prices
    - cron: '*/5 * * * *'

  # Manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      network:
        description: 'Network to use'
        required: true
        default: 'testnet'
        type: choice
        options:
          - testnet
          - mainnet

# Prevent concurrent runs
concurrency:
  group: oracle-update
  cancel-in-progress: false

jobs:
  update-prices:
    name: Update Oracle Prices
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --filter @bobt/price-updater

      - name: Update Oracle prices
        env:
          STELLAR_SECRET_KEY: ${{ secrets.STELLAR_SECRET_KEY }}
          ORACLE_CONTRACT_ID: ${{ vars.ORACLE_CONTRACT_ID || 'CBNL5SYNKPCKVESILEX457DL4RRE6NAUPWRKYO4WI2AOV733NRM2WAMI' }}
          NETWORK: ${{ inputs.network || 'testnet' }}
          CRIPTOYA_BASE_URL: 'https://criptoya.com/api'
        working-directory: services/price-updater
        run: pnpm run update-prices
        continue-on-error: true
        id: update

      - name: Check for stale price
        if: failure()
        run: |
          echo "::warning::Oracle price update failed. Price may become stale."

      - name: Summary
        if: always()
        run: |
          echo "## Oracle Price Update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Network | ${{ inputs.network || 'testnet' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.update.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Oracle | \`${{ vars.ORACLE_CONTRACT_ID || 'CBNL...' }}\` |" >> $GITHUB_STEP_SUMMARY
